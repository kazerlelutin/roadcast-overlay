<div
  class="countdown"
  description="Compte à rebours animé pour le live"
  title="Compte à rebours"
  script="
  Afficher_countdown_timer,
  Start_countdown_timer,
  Stop_countdown_timer, 
  Cacher_countdown_timer
  "
  tag="countdown, timer"
  inputs="number:temps_countdown"
>
  <div
    class="countdown-container"
    id="countdown-container"
    style="display: none"
  >
    <div id="countdown-progress" class="countdown-progress"></div>
    <div class="countdown-display-container">
      <div id="countdown-display" class="countdown-display">
        <div class="digit-container">
          <div class="digit-wrapper" id="minutes-tens">
            <div class="digit">0</div>
          </div>
          <div class="digit-wrapper" id="minutes-ones">
            <div class="digit">0</div>
          </div>
        </div>
        <span class="separator">:</span>
        <div class="digit-container">
          <div class="digit-wrapper" id="seconds-tens">
            <div class="digit">0</div>
          </div>
          <div class="digit-wrapper" id="seconds-ones">
            <div class="digit">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let started = false
    let rafId
    let totalSeconds = 600
    let currentSeconds = totalSeconds
    let lastTime = performance.now()
    let lastSecond = Math.floor(lastTime / 1000)

    function animate(currentTime) {
      if (!started) return
      const deltaTime = (currentTime - lastTime) / 1000
      currentSeconds -= deltaTime

      if (currentSeconds <= 0) {
        currentSeconds = 0
        started = false
        cancelAnimationFrame(rafId)
        updateDisplay()
        updateProgress()
        addPulseEffect()
        return
      }

      const currentSecondFloor = Math.floor(currentTime / 1000)
      if (currentSecondFloor > lastSecond) {
        updateDisplay()
        lastSecond = currentSecondFloor
      }
      updateProgress()
      lastTime = currentTime
      requestAnimationFrame(animate)
    }

    async function start_countdown_timer() {
      if (started) return
      currentSeconds = await get_time()
      totalSeconds = currentSeconds
      cleanupDigitAnimations()
      started = true
      rafId = requestAnimationFrame(animate)
    }

    function stop_countdown_timer() {
      if (!started) return
      started = false
      cancelAnimationFrame(rafId)
      currentSeconds = totalSeconds
      cleanupDigitAnimations()
      updateDisplay()
      updateProgress()
      removePulseEffect()
    }

    function addPulseEffect() {
      const display = document.getElementById('countdown-display')
      if (display) {
        display.classList.add('pulse-effect')
      }
    }

    function removePulseEffect() {
      const display = document.getElementById('countdown-display')
      if (display) {
        display.classList.remove('pulse-effect')
      }
    }

    function cleanupDigitAnimations() {
      const digitWrappers = [
        'minutes-tens',
        'minutes-ones',
        'seconds-tens',
        'seconds-ones',
      ]
      digitWrappers.forEach((id) => {
        const wrapper = document.getElementById(id)
        if (wrapper) {
          // Supprimer tous les chiffres sauf  premier
          const digits = wrapper.querySelectorAll('.digit')
          for (let i = 1; i < digits.length; i++) {
            digits[i].remove()
          }
          const remainingDigit = wrapper.querySelector('.digit')
          if (remainingDigit) {
            remainingDigit.classList.remove('new-digit', 'old-digit')
            remainingDigit.style.transform = 'translateY(0)'
          }
        }
      })
    }

    function updateDisplay() {
      const minutes = Math.floor(currentSeconds / 60)
      const seconds = currentSeconds % 60

      const minutesStr = Math.floor(minutes).toString().padStart(2, '0')
      const secondsStr = Math.floor(seconds).toString().padStart(2, '0')

      updateDigit('minutes-tens', minutesStr[0])
      updateDigit('minutes-ones', minutesStr[1])
      updateDigit('seconds-tens', secondsStr[0])
      updateDigit('seconds-ones', secondsStr[1])
    }

    function updateDigit(elementId, newValue) {
      const wrapper = document.getElementById(elementId)
      if (!wrapper) return

      const currentDigit = wrapper.querySelector('.digit')
      if (!currentDigit) return

      const currentValue = currentDigit.textContent

      if (currentValue === newValue) return
      if (
        wrapper.querySelector('.new-digit') ||
        wrapper.querySelector('.old-digit')
      ) {
        return
      }

      const newDigit = document.createElement('div')
      newDigit.className = 'digit new-digit'
      newDigit.textContent = newValue

      wrapper.appendChild(newDigit)

      currentDigit.classList.add('old-digit')

      setTimeout(() => {
        if (currentDigit.parentNode) {
          currentDigit.remove()
        }
        if (newDigit.parentNode) {
          newDigit.classList.remove('new-digit')
          newDigit.classList.add('digit')
        }
      }, 300)
    }

    function updateProgress() {
      const progress = ((totalSeconds - currentSeconds) / totalSeconds) * 100
      const progressBar = document.getElementById('countdown-progress')
      if (!progressBar) return
      progressBar.style.width = progress + '%'
    }

    async function get_time() {
      const timeRes = await fetch(`/api/actions/input/temps_countdown`)

      const resText = await timeRes.text()
      if (resText) {
        totalSeconds = parseInt(resText) * 60
      }

      return totalSeconds
    }

    function afficher_countdown_timer() {
      const countdownContainer = document.getElementById('countdown-container')
      if (countdownContainer) {
        countdownContainer.style.display = 'block'
      }
    }

    function cacher_countdown_timer() {
      const countdownContainer = document.getElementById('countdown-container')
      if (countdownContainer) {
        countdownContainer.style.display = 'none'
      }
    }

    globalThis.Afficher_countdown_timer = afficher_countdown_timer
    globalThis.Cacher_countdown_timer = cacher_countdown_timer
    globalThis.Start_countdown_timer = start_countdown_timer
    globalThis.Stop_countdown_timer = stop_countdown_timer
  </script>

  <style>
    :root {
      --color-bg: #f2f2f2;
      --color-primary: #4088cf;
      --color-white: #fff;
      --color-border: #ccc;
      --color-secondary: #e84855;
      --color-tertiary: #70cbe6;
      --color-text: #000;
      --color-accent: #d9534f;
      --color-valid: #4caf50;
      --color-brain: #d433a9;
      --color-error: #ad2626;
      --color-success: #00ff00;
      --color-info: #17a2b8;
      --color-warning: #ffc107;
      --color-discord: #5468ff;
      --color-discord-hover: #656c85cc;
    }

    .countdown-container {
      position: absolute;
      inset: 0;
    }

    .countdown-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      background: var(--color-info);
      height: 4em;
      transition: width 100ms ease-in-out;
    }

    .countdown-display-container {
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .countdown-display {
      font-size: 10em;
      font-weight: bold;
      font-family: console, monospace;
      color: white;

      line-height: 0.9;
      overflow: hidden;
      text-shadow: 0.05em 0.05em 0 rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 0.1em;
    }

    .digit-container {
      display: flex;
      gap: 0.05em;
    }

    .digit-wrapper {
      position: relative;
      width: 0.6em;
      height: 1em;
      overflow: hidden;
    }

    .digit {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease-in-out;
    }

    .new-digit {
      transform: translateY(100%);
      animation: slideIn 0.3s ease-in-out forwards;
    }

    .old-digit {
      animation: slideOut 0.3s ease-in-out forwards;
    }

    @keyframes slideIn {
      from {
        transform: translateY(100%);
        filter: blur(0.1em);
      }

      to {
        transform: translateY(0);
        filter: blur(0);
      }
    }

    @keyframes slideOut {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-100%);
      }
    }

    .separator {
      font-size: 0.8em;
      margin: 0 0.1em;
    }

    .pulse-effect {
      animation: pulse 1s ease-in-out infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        filter: brightness(1);
      }

      50% {
        transform: scale(1.05);
        filter: brightness(1.2);
      }

      100% {
        transform: scale(1);
        filter: brightness(1);
      }
    }
  </style>
</div>
